<section class="statistic">
  <h2 class="statistic__title">Statistic</h2>
  <div class="wrapper">
    <div class=" wrapper-controller">
      <div class="statistic__dropdown dropdown">
        <button class="dropdown__select-btn"
                (click)="isHidden = !isHidden"
        >
          <!--
          Selected dates:<span *ngIf="selected.length === 0"> V </span>
          <br>
          <span *ngIf="selected[0]"> {{selected[0] | date:"dd/MM/yy"}}</span>
          <span *ngIf="selected.length > 1">
        <span>{{selected.length === 2 ? " and " : " ... "}}</span>
        {{selected[selected.length - 1] | date:"dd/MM/yy"}}</span>
        -->
          Select subjects:
        </button>
        <form
          #form="ngForm"
          class="dropdown__content"
          [class.dropdown__content--hidden]="isHidden"
          [class.dropdown__content--visible]="!isHidden"
        >
          <div class="dropdown__controller">
            <div class="dropdown__controller-wrapper">
              <button class="dropdown__btn" (click)="checkAll()">Check All</button>
              <button class="dropdown__btn" (click)="unCheckAll()">Uncheck All</button>
            </div>
            <div class="dropdown__controller-wrapper">
              <button
                class="dropdown__btn"
                (click)="expandAll()"
                *ngIf="!(range[0] && range[1])">Expand All</button>
              <button
                *ngIf="!(range[0] && range[1])"
                class="dropdown__btn"
                (click)="collapseAll()">Collapse All</button>
            </div>
          </div>
          <ul class="dropdown__list">
            <li class="dropdown__item" *ngFor="let subject of subjects">
              <div class="dropdown__item-wrapper">
                <ng-container *ngIf="!subject[2]; else close">
                  <button
                    class="dropdown__expand"
                    (click)="expandOne(subject)"
                    [disabled]="range[0] && range[1]"
                  >▼</button>
                </ng-container>
                <ng-template #close>
                  <button
                    class="dropdown__expand"
                    (click)="collapseOne(subject)">▲</button>
                </ng-template>

                <app-dropdown
                  [(ngModel)]="subject[1]"
                  name="{{subject[0].name}}"
                  [label]="subject[0].name"
                  [checked]="subject[1]"
                  (change)="changeCheck(subject)"
                ></app-dropdown>
              </div>


              <form class="dropdown__dates"
                    #formDate="ngForm"
                    [class.dropdown__dates--hidden]="!subject[2]"
                    [class.dropdown__dates--visible]="subject[2]"
              >
                <ul class="dropdown__list dropdown__list--child">
                  <li class="dropdown__item dropdown__item--scale" *ngFor="let data of dates[subject[0].id]">

                    <app-dropdown
                      [(ngModel)]="data[1]"
                      name="{{data[0]}}"
                      [label]="data[0] | date:'MMM d, y'"
                      [checked]="data[1]"
                      (change)="changeCheck(subject, data)"
                    ></app-dropdown>
                  </li>
                </ul>
              </form>
            </li>
          </ul>
        </form>
      </div>
    </div>
    <div class="statistic__students">
      <div class="statistics__visuals-wrapper">

          <div class="statistic__selector-wrapper">
              <form class="date-form"  [formGroup]="dateSelector" (ngSubmit)="showChanges($event)">
                <select
                  class="statistic__selector"
                  formControlName="selector"
                >
                  <option
                    *ngFor="let option of ['date', 'week', 'month']"
                    [selected]="selectorType === option"
                    value="{{option}}"
                  >{{option}}</option>
                </select>
                <div class="date-form__wrapper">
                  <label>From: <input
                    class="date-input"
                    formControlName="from"
                    type="{{dateSelector.controls.selector.value}}"
                    [value]="mapTimestamp(range[0])"
                    [max]="dateSelector.value.to"
                  ></label>
                  <label>To:
                    <input
                      [value]="mapTimestamp(range[1])"
                      class="date-input"
                      formControlName="to" type="{{dateSelector.controls.selector.value}}"
                      [min]="dateSelector.value.from"
                    >
                  </label>
                </div>
                <app-button
                  [isDisabled]="!dateSelector.valid"
                  [textContent]="'Submit'"
                  [screenReader]="'Submit form'"
                  class="date-form__btn--submit"
                ></app-button>
              </form>
          </div>
        <!-- dateSelector.valid && range.length -->
        <ng-container >
          <app-barplot-date-range
            *ngIf="range.length"
            class="date-range__visuals"
            [data]="[subjects, marks, dates, students, range]"
            [renderType]="dateSelector.controls.selector.value"
          ></app-barplot-date-range>
          <ul class="statistics__visuals-list"  *ngIf="!(range[0] && range[1])">
            <li *ngFor="let barplot of getSelected(subjects); let i = index" class="statistics__barplot-container">
              <h3>{{barplot[0].name}}</h3>
              <app-barplot
                class="statistic__barplot"
                [data]="[barplot, marks, dates, students, selected]"
                [index]="i"
              ></app-barplot>
            </li>
          </ul>

        </ng-container>
      </div>
    </div>
  </div>
</section>


